import{_ as ce}from"./CommonCheckbox.vue.87c89bd7.js";import{d as F,az as se,aA as ae,c as g,j as i,t as _,a3 as N,a8 as de,cj as pe,aG as W,o as h,a6 as fe,f as y,w as V,k as C,a4 as be,p as ve,l as O,ck as me,a as z,q as f,L as le,h as t,aq as he,cl as re,cm as Y,O as _e,B as ye,C as ge,x as S,ar as Q,cn as we,co as $e,F as ke,J as E,b as Se,ci as Ve,aB as Ne,m as X,c6 as L,aa as Z,aT as Pe}from"./entry.6470c283.js";const Ce={"flex-1":"","ms-2":"","pointer-events-none":""},Ee=["value"],xe=F({__name:"CommonRadio",props:se({label:{},value:{},hover:{type:Boolean}},{modelValue:{}}),emits:["update:modelValue"],setup(a){const e=ae(a,"modelValue");return(n,o)=>(h(),g("label",{class:N(["common-radio flex items-center cursor-pointer py-1 text-md w-full gap-y-1",n.hover?"hover:bg-active ms--2 px-4 py-2":null]),onClick:o[1]||(o[1]=W(c=>e.value=n.value,["prevent"]))},[i("span",Ce,_(n.label),1),i("span",{class:N(e.value===n.value?"i-ri:radio-button-line":"i-ri:checkbox-blank-circle-line"),"aria-hidden":"true"},null,2),de(i("input",{"onUpdate:modelValue":o[0]||(o[0]=c=>e.value=c),type:"radio",value:n.value,"sr-only":""},null,8,Ee),[[pe,e.value]])],2))}});const Ae={key:0,role:"alert","aria-describedby":"notification-failed",flex:"~ col","gap-1":"","text-sm":"","pt-1":"","ps-2":"","pe-1":"","pb-2":"","text-red-600":"","dark:text-red-400":"",border:"~ base rounded red-600 dark:red-400"},Ue={id:"notification-failed",flex:"","justify-between":""},Be={flex:"","items-center":"","gap-x-2":"","font-bold":""},Te=i("div",{"aria-hidden":"true","i-ri:error-warning-fill":""},null,-1),Ie=["aria-label"],Oe=i("span",{"aria-hidden":"true",w:"1.75em",h:"1.75em","i-ri:close-line":""},null,-1),Ke=[Oe],Me={"py-2":""},Re=i("span",{"inline-block":"","aria-hidden":"true","i-ri:external-link-line":"",class:"rtl-flip"},null,-1),De={"py-2":""},qe=i("span",{"inline-block":"","aria-hidden":"true","i-ri:external-link-line":"",class:"rtl-flip"},null,-1),He=F({__name:"NotificationSubscribePushNotificationError",props:se({title:{},message:{}},{modelValue:{type:Boolean,required:!0}}),emits:["update:modelValue"],setup(a){const e=ae(a,"modelValue");return(n,o)=>{const c=be,b=ve,p=fe("i18n-t");return e.value?(h(),g("div",Ae,[i("head",Ue,[i("div",Be,[Te,i("p",null,_(n.title??n.$t("settings.notifications.push_notifications.subscription_error.title")),1)]),y(c,{placement:"bottom",content:n.$t("settings.notifications.push_notifications.subscription_error.clear_error")},{default:V(()=>[i("button",{flex:"","rounded-4":"",p1:"","hover:bg-active":"","cursor-pointer":"","transition-100":"","aria-label":n.$t("settings.notifications.push_notifications.subscription_error.clear_error"),onClick:o[0]||(o[0]=r=>e.value=!1)},Ke,8,Ie)]),_:1},8,["content"])]),i("p",null,_(n.message),1),i("p",Me,[y(p,{keypath:"settings.notifications.push_notifications.subscription_error.error_hint"},{default:V(()=>[y(b,{"font-bold":"",href:"https://docs.elk.zone/pwa#faq",target:"_blank","inline-flex":"~ row","items-center":"","gap-x-2":""},{default:V(()=>[O(" https://docs.elk.zone/pwa#faq "),Re]),_:1})]),_:1})]),i("p",De,[y(b,{"font-bold":"","text-primary":"",href:"https://github.com/elk-zone/elk",target:"_blank",flex:"~ row","items-center":"","gap-x-2":""},{default:V(()=>[O(_(n.$t("settings.notifications.push_notifications.subscription_error.repo_link"))+" ",1),qe]),_:1})])])):C("",!0)}}}),je={flex:"","items-center":"","pb-2":""},ze={id:"notifications-warning","text-md":"","font-bold":"","w-full":""},Fe=["title","disabled"],Le=i("span",{"aria-hidden":"true","i-ri:close-line":""},null,-1),We=[Le],Ye={"xl:hidden":""},Ge={"xl:hidden":""},Je={key:1},Qe={key:2},Xe=["disabled"],Ze={key:0,"aria-hidden":"true",block:"","animate-spin":"","preserve-3d":""},et=i("span",{block:"","i-ri:loader-2-fill":"","aria-hidden":"true"},null,-1),tt=[et],ot={key:1,"aria-hidden":"true",block:"","i-ri:check-line":""},it=F({__name:"NotificationEnablePushNotification.client",props:{closeableHeader:{type:Boolean},busy:{type:Boolean},animate:{type:Boolean}},emits:["hide","subscribe"],setup(a){const e=me("(min-width: 1280px)"),n=z(()=>!f.value?.vapidKey);return(o,c)=>(h(),g("div",{flex:"~ col","gap-y-2":"",role:"alert","aria-labelledby":"notifications-warning",class:N(o.closeableHeader?"border-b border-base":"px6 px4")},[i("header",je,[i("h2",ze,_(o.$t("settings.notifications.push_notifications.warning.enable_title")),1),o.closeableHeader?(h(),g("button",{key:0,flex:"","rounded-4":"",type:"button",title:o.$t("settings.notifications.push_notifications.warning.enable_close"),"hover:bg-active":"","cursor-pointer":"","transition-100":"",disabled:o.busy,onClick:c[0]||(c[0]=b=>o.$emit("hide"))},We,8,Fe)):C("",!0)]),o.closeableHeader?(h(),g(le,{key:0},[i("p",Ye,_(o.$t("settings.notifications.push_notifications.warning.enable_description")),1),i("p",Ge,_(o.$t("settings.notifications.push_notifications.warning.enable_description_mobile")),1),i("p",{class:N(t(e)?null:"hidden")},_(o.$t("settings.notifications.push_notifications.warning.enable_description_desktop")),3)],64)):(h(),g("p",Je,_(o.$t("settings.notifications.push_notifications.warning.enable_description_settings")),1)),t(n)?(h(),g("p",Qe,_(o.$t("settings.notifications.push_notifications.warning.re_auth")),1)):C("",!0),i("button",{"btn-outline":"","rounded-full":"","font-bold":"",py4:"",flex:"~ gap2 center",m5:"",type:"button",class:N(o.busy||t(n)?"border-transparent":null),disabled:o.busy||t(n),onClick:c[1]||(c[1]=b=>o.$emit("subscribe"))},[o.busy&&o.animate?(h(),g("span",Ze,tt)):(h(),g("span",ot)),i("span",null,_(o.$t("settings.notifications.push_notifications.warning.enable_desktop")),1)],10,Xe),he(o.$slots,"error")],2))}});class j extends Error{code;constructor(e,n){super(n),this.code=e}}async function nt(a,e,n="all",o=!1){const{server:c,vapidKey:b}=a;return await ee().then(te).then(({registration:p,subscription:r})=>{if(r){const $=new Uint8Array(r.options.applicationServerKey).toString();if(ue(b).toString()===$&&r.endpoint===c&&!o&&a.pushSubscription)return Promise.resolve(a.pushSubscription);if(a.pushSubscription)return ie(!1,!1).catch(st).then(()=>oe(p,b)).then(P=>ne(P,e,n))}return oe(p,b).then($=>ne($,e,n))}).catch(p=>{let r=p;return p.code===11&&p.name==="InvalidStateError"?r=new j("too_many_registrations","Too many registrations"):p.code===20&&p.name==="AbortError"?r=new j("vapid_not_supported","Your browser supports Web Push Notifications, but does not seem to implement the VAPID protocol."):p.code===5&&p.name==="InvalidCharacterError"&&(r=new j("invalid_vapid_key",`The VAPID public key seems to be invalid: ${b}`)),ee().then(te).then(()=>ie(!0)).then(()=>Promise.resolve(void 0)).catch($=>(console.error($),Promise.resolve(void 0))).finally(()=>Promise.reject(r))})}function ue(a){const e="=".repeat((4-a.length%4)%4),n=`${a}${e}`.replace(/-/g,"+").replace(/_/g,"/"),o=window.atob(n),c=new Uint8Array(o.length);for(let b=0;b<o.length;++b)c[b]=o.charCodeAt(b);return c}function ee(){return navigator.serviceWorker.ready}async function te(a){const e=await a.pushManager.getSubscription();return{registration:a,subscription:e}}async function oe(a,e){return await a.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:ue(e)})}async function ie(a,e=!0){const n=f.value;n&&(await re(n),e&&await Y(n,a))}async function st(a){const e=f.value;throw e&&await Y(e,!0),a}async function ne(a,e,n){const{endpoint:o,keys:c}=a.toJSON(),b={policy:n,subscription:{endpoint:o,keys:{p256dh:c.p256dh,auth:c.auth}},data:e};return await _e().v1.webPushSubscriptions.create(b)}const at=typeof window<"u"&&"serviceWorker"in navigator&&"PushManager"in window&&"getKey"in PushSubscription.prototype;function lt(){const a=ye(),e=ge(a,"client"),n=S(!1),o=S(Notification.permission==="denied"?"denied":Notification.permission==="granted"?"granted":Notification.permission==="default"?"prompt":void 0),c=z(()=>at),b=Q(we,{}),p=Q($e,{}),r=S(H(f.value?.pushSubscription,p.value[f.value?.account?.acct??""])),$=S(H(f.value?.pushSubscription,p.value[f.value?.account?.acct??""])),K=z(()=>{const l=r.value,m=$.value;return l.favourite!==m.favourite||l.reblog!==m.reblog||l.mention!==m.mention||l.follow!==m.follow||l.poll!==m.poll||l.policy!==m.policy});ke(()=>f.value?.pushSubscription,l=>{n.value=!!l,r.value=H(l,p.value[f.value?.account?.acct??""]),$.value=H(l,p.value[f.value?.account?.acct??""])},{immediate:!0,flush:"post"});const P=async(l,m,k)=>{if(!c.value)return"not-supported";if(!f.value)return"no-user";const{pushSubscription:w,server:U,token:B,vapidKey:R,account:{acct:D}}=f.value;if(!B||!U||!R)return"invalid-vapid-key";const T=await Promise.resolve(Notification.requestPermission()).then(s=>s==="default"?"prompt":s);return T==="denied"?(o.value=T,"notification-denied"):(f.value.pushSubscription=await nt({pushSubscription:w,server:U,token:B,vapidKey:R},l??{alerts:{follow:!0,favourite:!0,reblog:!0,mention:!0,poll:!0}},m??"all",k),await E(),o.value=T,b.value[D]=!0,"subscribed")},x=async()=>{if(!c.value||!n||!f.value)return!1;await re(f.value),await Y(f.value)},M=async l=>{l&&(r.value.policy=l);const m=r.value;$.value={favourite:m.favourite,reblog:m.reblog,mention:m.mention,follow:m.follow,poll:m.poll,policy:m.policy},l?p.value[f.value.account.acct??""]=l:p.value[f.value.account.acct??""]=r.value.policy,await E()},v=()=>{const l=$.value;r.value={favourite:l.favourite,reblog:l.reblog,mention:l.mention,follow:l.follow,poll:l.poll,policy:l.policy},p.value[f.value.account.acct??""]=l.policy},A=async()=>{if(f.value){const l=$.value,m={alerts:{follow:r.value.follow,favourite:r.value.favourite,reblog:r.value.reblog,mention:r.value.mention,poll:r.value.poll}},k=r.value.policy,w=l.policy!==k;w?await P(m,k,!0):f.value.pushSubscription=await e.value.v1.webPushSubscriptions.update({data:m}),w&&await E(),await M(w?k:void 0)}};return{pushNotificationData:r,saveEnabled:K,undoChanges:v,hiddenNotification:b,isSupported:c.value,isSubscribed:n,notificationPermission:o,updateSubscription:A,subscribe:P,unsubscribe:x}}function H(a,e){return{follow:a?.alerts.follow??!0,favourite:a?.alerts.favourite??!0,reblog:a?.alerts.reblog??!0,mention:a?.alerts.mention??!0,poll:a?.alerts.poll??!0,policy:e??"all"}}const rt=Pe(it),ut={key:0,"aria-labelledby":"pn-s"},ct={key:0,flex:"~ col",border:"b base"},dt={id:"pn-settings",px6:"",py4:"",mt2:"","font-bold":"","text-xl":"",flex:"~ gap-1","items-center":""},pt={key:0,flex:"~ col"},ft=["onSubmit"],bt={id:"pn-instructions","text-sm":"",pb2:"","aria-hidden":"true"},vt={flex:"~ col","gap-y-1":"","py-1":""},mt={flex:"~ col","gap-y-1":"","py-1":""},ht={flex:"~ col","gap-y-4":"","gap-x-2":"","py-1":"",sm:"~ justify-between flex-row"},_t=["disabled"],yt={key:0,"aria-hidden":"true",block:"","animate-spin":"","preserve-3d":""},gt=i("span",{block:"","i-ri:loader-2-fill":"","aria-hidden":"true"},null,-1),wt=[gt],$t={key:1,block:"","aria-hidden":"true","i-ri:save-2-fill":""},kt=["disabled"],St=i("span",{"aria-hidden":"true",class:"block i-material-symbols:undo-rounded"},null,-1),Vt=["onSubmit"],Nt=i("span",{border:"b base 2px",class:"bg-$c-text-secondary"},null,-1),Pt=["disabled"],Ct={key:0,"aria-hidden":"true",block:"","animate-spin":"","preserve-3d":""},Et=i("span",{block:"","i-ri:loader-2-fill":"","aria-hidden":"true"},null,-1),xt=[Et],At={key:1,block:"","aria-hidden":"true","i-material-symbols:cancel-rounded":""},Ut={key:1,px6:"",pb4:"",role:"alert","aria-labelledby":"n-unsupported"},Bt={id:"n-unsupported"},Ot=F({__name:"NotificationPreferences.client",props:{show:{type:Boolean}},setup(a){const{pushNotificationData:e,saveEnabled:n,undoChanges:o,hiddenNotification:c,isSubscribed:b,isSupported:p,notificationPermission:r,updateSubscription:$,subscribe:K,unsubscribe:P}=lt(),{t:x}=Se(),M=Ve().pwaEnabled;let v=S(!1),A=S(!1),l=S(!1),m=S(!1),k=S(""),w=S(!1);function U(){const s=f.value?.account?.acct;s&&(c.value[s]=!0)}const B=z(()=>M?p&&(!b.value||!r.value||r.value==="prompt")&&c.value[f.value?.account?.acct??""]!==!0:!1);async function R(){if(!v.value){v.value=!0,await E(),A.value=!0;try{await $()}catch(s){console.error(s)}finally{v.value=!1,A.value=!1}}}async function D(){if(!v.value){v.value=!0,await E(),l.value=!0;try{const s=await K();s!=="subscribed"&&(k.value=x(`settings.notifications.push_notifications.subscription_error.${s==="notification-denied"?"permission_denied":"request_error"}`),w.value=!0)}catch(s){s instanceof j?k.value=x(`settings.notifications.push_notifications.subscription_error.${s.code}`):(console.error(s),k.value=x("settings.notifications.push_notifications.subscription_error.request_error")),w.value=!0}finally{v.value=!1,l.value=!1}}}async function T(){if(!v.value){v.value=!0,await E(),m.value=!0;try{await P()}catch(s){console.error(s)}finally{v.value=!1,m.value=!1}}}return Ne(()=>v.value=!1),(s,d)=>{const I=ce,q=xe,G=He,J=rt;return t(M)&&(B.value||s.show)?(h(),g("section",ut,[y(L,{name:"slide-down"},{default:V(()=>[s.show?(h(),g("div",ct,[i("h3",dt,_(s.$t("settings.notifications.push_notifications.label")),1),t(p)?(h(),g(le,{key:0},[t(b)?(h(),g("div",pt,[i("form",{flex:"~ col","gap-y-2":"",px6:"",pb4:"",onSubmit:W(R,["prevent"])},[i("p",bt,_(s.$t("settings.notifications.push_notifications.instructions")),1),i("fieldset",vt,[i("legend",null,_(s.$t("settings.notifications.push_notifications.alerts.title")),1),y(I,{modelValue:t(e).follow,"onUpdate:modelValue":d[0]||(d[0]=u=>t(e).follow=u),hover:"",label:s.$t("settings.notifications.push_notifications.alerts.follow")},null,8,["modelValue","label"]),y(I,{modelValue:t(e).favourite,"onUpdate:modelValue":d[1]||(d[1]=u=>t(e).favourite=u),hover:"",label:s.$t("settings.notifications.push_notifications.alerts.favourite")},null,8,["modelValue","label"]),y(I,{modelValue:t(e).reblog,"onUpdate:modelValue":d[2]||(d[2]=u=>t(e).reblog=u),hover:"",label:s.$t("settings.notifications.push_notifications.alerts.reblog")},null,8,["modelValue","label"]),y(I,{modelValue:t(e).mention,"onUpdate:modelValue":d[3]||(d[3]=u=>t(e).mention=u),hover:"",label:s.$t("settings.notifications.push_notifications.alerts.mention")},null,8,["modelValue","label"]),y(I,{modelValue:t(e).poll,"onUpdate:modelValue":d[4]||(d[4]=u=>t(e).poll=u),hover:"",label:s.$t("settings.notifications.push_notifications.alerts.poll")},null,8,["modelValue","label"])]),i("fieldset",mt,[i("legend",null,_(s.$t("settings.notifications.push_notifications.policy.title")),1),y(q,{modelValue:t(e).policy,"onUpdate:modelValue":d[5]||(d[5]=u=>t(e).policy=u),hover:"",value:"all",label:s.$t("settings.notifications.push_notifications.policy.all")},null,8,["modelValue","label"]),y(q,{modelValue:t(e).policy,"onUpdate:modelValue":d[6]||(d[6]=u=>t(e).policy=u),hover:"",value:"followed",label:s.$t("settings.notifications.push_notifications.policy.followed")},null,8,["modelValue","label"]),y(q,{modelValue:t(e).policy,"onUpdate:modelValue":d[7]||(d[7]=u=>t(e).policy=u),hover:"",value:"follower",label:s.$t("settings.notifications.push_notifications.policy.follower")},null,8,["modelValue","label"]),y(q,{modelValue:t(e).policy,"onUpdate:modelValue":d[8]||(d[8]=u=>t(e).policy=u),hover:"",value:"none",label:s.$t("settings.notifications.push_notifications.policy.none")},null,8,["modelValue","label"])]),i("div",ht,[i("button",{"btn-solid":"","font-bold":"",py2:"","full-w":"","sm-wa":"",flex:"~ gap2 center",class:N(t(v)||!t(n)?"border-transparent":null),disabled:t(v)||!t(n)},[t(v)&&t(A)?(h(),g("span",yt,wt)):(h(),g("span",$t)),O(" "+_(s.$t("settings.notifications.push_notifications.save_settings")),1)],10,_t),i("button",{"btn-outline":"","font-bold":"",py2:"","full-w":"","sm-wa":"",flex:"~ gap2 center",type:"button",class:N(t(v)||!t(n)?"border-transparent":null),disabled:t(v)||!t(n),onClick:d[9]||(d[9]=(...u)=>t(o)&&t(o)(...u))},[St,O(" "+_(s.$t("settings.notifications.push_notifications.undo_settings")),1)],10,kt)])],40,ft),i("form",{flex:"~ col","mt-4":"",onSubmit:W(T,["prevent"])},[Nt,i("button",{"btn-outline":"","rounded-full":"","font-bold":"","py-4":"",flex:"~ gap2 center",m5:"",class:N(t(v)?"border-transparent":null),disabled:t(v)},[t(v)&&t(m)?(h(),g("span",Ct,xt)):(h(),g("span",At)),O(" "+_(s.$t("settings.notifications.push_notifications.unsubscribe")),1)],10,Pt)],40,Vt)])):(h(),X(J,{key:1,animate:t(l),busy:t(v),onHide:U,onSubscribe:D},{error:V(()=>[y(L,{name:"slide-down"},{default:V(()=>[y(G,{modelValue:t(w),"onUpdate:modelValue":d[10]||(d[10]=u=>Z(w)?w.value=u:w=u),message:t(k)},null,8,["modelValue","message"])]),_:1})]),_:1},8,["animate","busy"]))],64)):(h(),g("div",Ut,[i("p",Bt,_(s.$t("settings.notifications.push_notifications.unsupported")),1)]))])):C("",!0)]),_:1}),B.value&&!s.show?(h(),X(J,{key:0,"closeable-header":"",px5:"",py4:"",animate:t(l),busy:t(v),onHide:U,onSubscribe:D},{error:V(()=>[y(L,{name:"slide-down"},{default:V(()=>[y(G,{modelValue:t(w),"onUpdate:modelValue":d[11]||(d[11]=u=>Z(w)?w.value=u:w=u),message:t(k)},null,8,["modelValue","message"])]),_:1})]),_:1},8,["animate","busy"])):C("",!0)])):C("",!0)}}});export{Ot as _};
